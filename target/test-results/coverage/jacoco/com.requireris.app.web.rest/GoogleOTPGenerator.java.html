<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GoogleOTPGenerator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Requireris</a> &gt; <a href="index.source.html" class="el_package">com.requireris.app.web.rest</a> &gt; <span class="el_source">GoogleOTPGenerator.java</span></div><h1>GoogleOTPGenerator.java</h1><pre class="source lang-java linenums">package com.requireris.app.web.rest;

/**
 * Created by noboud_n on 06/11/2016.
 */

import com.google.api.client.auth.oauth2.TokenResponse;
import com.google.api.client.googleapis.auth.oauth2.GoogleAuthorizationCodeFlow;
import com.google.api.client.googleapis.auth.oauth2.GoogleAuthorizationCodeRequestUrl;
import com.google.api.client.googleapis.auth.oauth2.GoogleCredential;
import com.google.api.client.http.javanet.NetHttpTransport;
import com.google.api.client.json.jackson2.JacksonFactory;
import com.google.api.client.util.ArrayMap;
import com.google.api.client.util.Base64;
import com.google.api.client.util.ByteStreams;
import com.google.api.services.oauth2.Oauth2;
import com.google.api.services.oauth2.model.Userinfoplus;
import com.google.firebase.FirebaseApp;
import com.google.firebase.FirebaseOptions;
import com.google.firebase.database.*;
import org.json.JSONException;
import org.json.JSONObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.MediaType;
import org.springframework.web.bind.annotation.*;

import javax.crypto.KeyGenerator;
import javax.crypto.SecretKey;
import javax.servlet.http.Cookie;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.ByteArrayOutputStream;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.util.Collections;
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.Semaphore;

@CrossOrigin
@RestController
@RequestMapping(&quot;/api&quot;)
public class GoogleOTPGenerator {

	@Autowired
	private HttpServletRequest request;

	private DatabaseReference usersRef;

<span class="fc" id="L51">	public GoogleOTPGenerator() {</span>
		try {
<span class="fc" id="L53">			FirebaseOptions options = new FirebaseOptions.Builder()</span>
<span class="fc" id="L54">					.setServiceAccount(new FileInputStream(System.getProperty(&quot;user.dir&quot;) + &quot;/target/classes/google-services.json&quot;))</span>
<span class="fc" id="L55">					.setDatabaseUrl(&quot;https://requireris-6348a.firebaseio.com&quot;)</span>
<span class="fc" id="L56">					.build();</span>
<span class="fc" id="L57">			FirebaseApp.initializeApp(options);</span>
<span class="fc" id="L58">			FirebaseDatabase database = FirebaseDatabase.getInstance();</span>
<span class="fc" id="L59">			DatabaseReference ref = database.getReference(&quot;/&quot;);</span>
<span class="fc" id="L60">			usersRef = ref.child(&quot;users&quot;);</span>
<span class="nc" id="L61">		} catch (Exception e) {</span>
<span class="nc" id="L62">			e.printStackTrace();</span>
<span class="nc" id="L63">			System.exit(-1);</span>
<span class="fc" id="L64">		}</span>
<span class="fc" id="L65">	}</span>

	private String getId(HttpServletRequest request) {
<span class="nc" id="L68">		String id = null;</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">		for (Cookie c : request.getCookies())</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">			if (c.getName().equals(&quot;Requireris&quot;))</span>
<span class="nc" id="L71">				id = new String(Base64.decodeBase64 (c.getValue()));</span>
<span class="nc" id="L72">		return id;</span>
	}

    @RequestMapping(value = &quot;/generate/{moduleType}&quot;,
            method = RequestMethod.POST,
            produces = MediaType.APPLICATION_JSON_VALUE)
    public @ResponseBody String generateGoogleOTP(@RequestParam(name = &quot;key&quot;, required = false) String key, @PathVariable String moduleType) throws InterruptedException {
<span class="nc" id="L79">		String password = null;</span>
<span class="nc" id="L80">		String id = getId(request);</span>
<span class="nc" id="L81">        Authentication auth = new Authentication();</span>

<span class="nc bnc" id="L83" title="All 6 branches missed.">		if ((key == null || key.equals(&quot;&quot;)) &amp;&amp; id != null) {</span>
<span class="nc" id="L84">			final Semaphore semaphore = new Semaphore(0);</span>
<span class="nc" id="L85">			final String infos[] = new String[1];</span>
<span class="nc" id="L86">			infos[0] = null;</span>
<span class="nc" id="L87">			usersRef.orderByChild(&quot;id&quot;).equalTo(id).addChildEventListener(new ChildEventListener() {</span>
				@Override
				public void onChildAdded(DataSnapshot dataSnapshot, String prevChildKey) {
					try {
<span class="nc" id="L91">						HashMap&lt;String, String&gt; map = (HashMap) dataSnapshot.getValue();</span>
<span class="nc" id="L92">						String key = map.get(moduleType + &quot;Key&quot;);</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">						if (key != null) {</span>
<span class="nc" id="L94">							infos[0] = new String(Base64.decodeBase64(key));</span>
						}
<span class="nc" id="L96">					} catch (Exception e) {</span>
<span class="nc" id="L97">						e.printStackTrace();</span>
<span class="nc" id="L98">					}</span>
<span class="nc" id="L99">					semaphore.release();</span>
<span class="nc" id="L100">				}</span>
				@Override
<span class="nc" id="L102">				public void onChildChanged(DataSnapshot dataSnapshot, String s) {semaphore.release();}</span>
				@Override
<span class="nc" id="L104">				public void onChildRemoved(DataSnapshot dataSnapshot) 			{semaphore.release();}</span>
				@Override
<span class="nc" id="L106">				public void onChildMoved(DataSnapshot dataSnapshot, String s) 	{semaphore.release();}</span>
				@Override
<span class="nc" id="L108">				public void onCancelled(DatabaseError databaseError) 			{semaphore.release();}</span>
			});
<span class="nc" id="L110">			Runnable run = () -&gt; {try {Thread.sleep(5000);} catch (InterruptedException e) {e.printStackTrace();} semaphore.release();}; new Thread(run).start();</span>
<span class="nc" id="L111">			semaphore.acquire();</span>
<span class="nc" id="L112">			key = infos[0];</span>
		}

        try {
<span class="nc bnc" id="L116" title="All 4 branches missed.">            if (key == null || key.equals(&quot;&quot;)) {</span>
<span class="nc" id="L117">                return &quot;Generation of password failed : empty key.&quot;;</span>
            }
<span class="nc" id="L119">            password = auth.GoogleAuthenticatorCode(key);</span>
<span class="nc" id="L120">        } catch (Exception e) {</span>
<span class="nc" id="L121">            e.printStackTrace();</span>
<span class="nc" id="L122">            return &quot;Generation of password failed. Please verify your secret key.&quot;;</span>
<span class="nc" id="L123">        }</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (password == null) {</span>
<span class="nc" id="L125">            return &quot;Generation of password failed : invalid password. Please try again later.&quot;;</span>
        }
<span class="nc" id="L127">        return password;</span>
    }

	@RequestMapping(value = &quot;/getAuthorize&quot;, method = RequestMethod.GET, produces = MediaType.APPLICATION_JSON_VALUE)
	public String generateAuthorizeUrl() throws Exception {
<span class="nc" id="L132">		GoogleAuthorizationCodeFlow flow = GoogleFlow.getFlow();</span>

<span class="nc" id="L134">		String redirect = &quot;http://&quot; + request.getServerName() + request.getContextPath() + &quot;:&quot; + request.getLocalPort() + &quot;/api/authorize&quot;;</span>

<span class="nc" id="L136">		KeyGenerator keyGen = KeyGenerator.getInstance(&quot;AES&quot;);</span>
<span class="nc" id="L137">		keyGen.init(256);</span>
<span class="nc" id="L138">		SecretKey secretKey = keyGen.generateKey();</span>
<span class="nc" id="L139">		byte[] encoded = secretKey.getEncoded();</span>

<span class="nc" id="L141">		GoogleAuthorizationCodeRequestUrl authUrl = flow.newAuthorizationUrl()</span>
<span class="nc" id="L142">				.setAccessType(&quot;offline&quot;)</span>
<span class="nc" id="L143">				.setRedirectUri(redirect)</span>
<span class="nc" id="L144">				.setState(new String(encoded))</span>
<span class="nc" id="L145">				.setResponseTypes(Collections.singletonList(&quot;code&quot;));</span>

<span class="nc" id="L147">		JSONObject obj = new JSONObject();</span>
<span class="nc" id="L148">		obj.put(&quot;url&quot;, authUrl.toString());</span>
<span class="nc" id="L149">		obj.put(&quot;key&quot;, new String(encoded));</span>

<span class="nc" id="L151">		return obj.toString();</span>
	}

	@RequestMapping(value = &quot;/authorize&quot;, method = RequestMethod.GET, produces = MediaType.TEXT_HTML_VALUE)
	public String receiveAuthorize(@RequestParam(value = &quot;state&quot;, required = false) String state, @RequestParam(value = &quot;code&quot;, required = false) String code, @RequestParam(value = &quot;error&quot;, required = false) String error) throws Exception {
<span class="nc bnc" id="L156" title="All 6 branches missed.">		if (error != null || code == null || state == null) {</span>
<span class="nc" id="L157">			return &quot;&lt;div style='padding: 20px; background-color: red; color: white; margin-bottom: 15px;'&gt;&lt;p style='text-align: center;'&gt;&lt;strong&gt;Error.&lt;/strong&gt; You can now close the tab&lt;/p&gt;&lt;/div&gt;&quot;;</span>
		}

<span class="nc" id="L160">		GoogleAuthorizationCodeFlow flow = GoogleFlow.getFlow();</span>

<span class="nc" id="L162">		String redirect = &quot;http://&quot; + request.getServerName() + request.getContextPath() + &quot;:&quot; + request.getLocalPort() + &quot;/api/authorize&quot;;</span>
<span class="nc" id="L163">		TokenResponse tokenResponse = flow.newTokenRequest(code).setRedirectUri(redirect).execute();</span>

<span class="nc" id="L165">		GoogleCredential credential = new GoogleCredential().setAccessToken(tokenResponse.getAccessToken());</span>
<span class="nc" id="L166">		Oauth2 oauth2 = new Oauth2.Builder(new NetHttpTransport(), new JacksonFactory(), credential).setApplicationName(&quot;Oauth2&quot;).build();</span>
<span class="nc" id="L167">		Userinfoplus userinfo = oauth2.userinfo().get().execute();</span>

<span class="nc" id="L169">		Map&lt;String, Object&gt; update = new HashMap&lt;&gt;();</span>
<span class="nc" id="L170">		update.put(String.valueOf(userinfo.getId()) + &quot;/id&quot;, String.valueOf(userinfo.getId()));</span>
<span class="nc" id="L171">		update.put(String.valueOf(userinfo.getId()) + &quot;/name&quot;, userinfo.getGivenName() + &quot; &quot; + userinfo.getFamilyName());</span>
<span class="nc" id="L172">		update.put(String.valueOf(userinfo.getId()) + &quot;/key&quot;, state);</span>

		//synchronize upload
<span class="nc" id="L175">		final Semaphore semaphore = new Semaphore(0);</span>
<span class="nc" id="L176">		final String message[] = new String[1];</span>
<span class="nc" id="L177">		usersRef.updateChildren(update, (databaseError, databaseReference) -&gt; {</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">			if (databaseError == null) {</span>
<span class="nc" id="L179">				message[0] = &quot;&lt;div style='padding: 20px; background-color: #4CAF50; color: white; margin-bottom: 15px;'&gt;&lt;p style='text-align: center;'&gt;&lt;strong&gt;Success !&lt;/strong&gt; You can close the tab.&lt;/div&gt;&quot;;</span>
			} else {
<span class="nc" id="L181">				message[0] = &quot;&lt;div style='padding: 20px; background-color: red; color: white; margin-bottom: 15px;'&gt;&lt;p style='text-align: center;'&gt;&lt;strong&gt;Error with firebase.&lt;/strong&gt; You can close the tab&lt;/div&gt;&quot;;</span>
			}
<span class="nc" id="L183">			semaphore.release();</span>
<span class="nc" id="L184">		});</span>
<span class="nc" id="L185">		semaphore.acquire();</span>

<span class="nc" id="L187">		return message[0];</span>
	}

	@RequestMapping(value = &quot;/getAuthorizeData&quot;, method = RequestMethod.POST, produces = MediaType.APPLICATION_JSON_VALUE)
	public String getAuthorize(@RequestParam(value = &quot;key&quot;) String key) throws JSONException, InterruptedException {
<span class="nc" id="L192">		final Semaphore semaphore = new Semaphore(0);</span>
<span class="nc" id="L193">		final String infos[] = new String[2];</span>
<span class="nc" id="L194">		infos[0] = null;</span>
<span class="nc" id="L195">		infos[1] = null;</span>
<span class="nc" id="L196">		usersRef.orderByChild(&quot;key&quot;).equalTo(key).addChildEventListener(new ChildEventListener() {</span>
			@Override
			public void onChildAdded(DataSnapshot dataSnapshot, String prevChildKey) {
<span class="nc" id="L199">				HashMap&lt;String, String&gt; map = (HashMap) dataSnapshot.getValue();</span>
				try {
<span class="nc" id="L201">					infos[0] = map.get(&quot;id&quot;);</span>
<span class="nc" id="L202">					infos[1] = map.get(&quot;name&quot;);</span>
<span class="nc" id="L203">				} catch (Exception e) {</span>
<span class="nc" id="L204">					infos[0] = null;</span>
<span class="nc" id="L205">					infos[1] = null;</span>
<span class="nc" id="L206"> 				}</span>
<span class="nc" id="L207">				semaphore.release();</span>
<span class="nc" id="L208">			}</span>
			@Override
<span class="nc" id="L210">			public void onChildChanged(DataSnapshot dataSnapshot, String s) {semaphore.release();}</span>
			@Override
<span class="nc" id="L212">			public void onChildRemoved(DataSnapshot dataSnapshot) 			{semaphore.release();}</span>
			@Override
<span class="nc" id="L214">			public void onChildMoved(DataSnapshot dataSnapshot, String s) 	{semaphore.release();}</span>
			@Override
<span class="nc" id="L216">			public void onCancelled(DatabaseError databaseError) 			{semaphore.release();}</span>
		});
<span class="nc" id="L218">		Runnable run = () -&gt; {try {Thread.sleep(5000);} catch (InterruptedException e) {e.printStackTrace();} semaphore.release();}; new Thread(run).start();</span>
<span class="nc" id="L219">		semaphore.acquire();</span>

<span class="nc bnc" id="L221" title="All 4 branches missed.">		if (infos[0] != null &amp;&amp; infos[1] != null) {</span>
<span class="nc" id="L222">			Map&lt;String, Object&gt; update = new HashMap&lt;&gt;();</span>
<span class="nc" id="L223">			update.put(String.valueOf(infos[0]) + &quot;/key&quot;, null);</span>
<span class="nc" id="L224">			usersRef.updateChildren(update, (databaseError, databaseReference) -&gt; semaphore.release());</span>
<span class="nc" id="L225">			semaphore.acquire();</span>

<span class="nc" id="L227">			JSONObject info = new JSONObject();</span>
<span class="nc" id="L228">			info.put(&quot;id&quot;, Base64.encodeBase64String(infos[0].getBytes()));</span>
<span class="nc" id="L229">			info.put(&quot;name&quot;, infos[1]);</span>
<span class="nc" id="L230">			return info.toString();</span>
		}
<span class="nc" id="L232">		JSONObject err = new JSONObject();</span>
<span class="nc" id="L233">		err.put(&quot;error&quot;, &quot;Error.&quot;);</span>
<span class="nc" id="L234">		return err.toString();</span>
	}

	@RequestMapping(value = &quot;/updateKey/{moduleType}&quot;, method = RequestMethod.POST, produces = MediaType.APPLICATION_JSON_VALUE)
	public String updateKey(@RequestParam(value = &quot;key&quot;) String key, @PathVariable String moduleType) throws JSONException, InterruptedException {
<span class="nc" id="L239">		String id = getId(request);</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">		if (id == null)</span>
<span class="nc" id="L241">			return &quot;Unable to update. Please log in.&quot;;</span>

<span class="nc" id="L243">		final String message[] = new String[1];</span>
<span class="nc" id="L244">		final Semaphore semaphore = new Semaphore(0);</span>
<span class="nc" id="L245">		Map&lt;String, Object&gt; update = new HashMap&lt;&gt;();</span>
<span class="nc" id="L246">		update.put(String.valueOf(id) + &quot;/&quot; + moduleType + &quot;Key&quot;, Base64.encodeBase64String(key.getBytes()));</span>
<span class="nc" id="L247">		usersRef.updateChildren(update, (databaseError, databaseReference) -&gt; {</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">			message[0] = (databaseError == null ? &quot;Key updated.&quot; : &quot;Error with firebase. Key not updated.&quot;);</span>
<span class="nc" id="L249">			semaphore.release();</span>
<span class="nc" id="L250">		});</span>
<span class="nc" id="L251">		semaphore.acquire();</span>

<span class="nc" id="L253">		return message[0];</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.7.201606060606</span></div></body></html>